---
title: "NORC AmeriSpeak Omnibus: Final Tables"
author: "Erik Westlund"
date: "2025-06-02"
date-modified: "`r format(Sys.Date(), '%Y-%m-%d')`"
format: 
  html:
    toc: true
    toc-float: true
    toc-depth: 5
    theme: cosmo
    code-fold: true
    fontsize: 1em
    linestretch: 1.1
    self-contained: true
execute:
  echo: false
  warning: false
  message: false
  cache: false
editor:
  render-on-save: true
---

```{r setup}
#| include: false


# Load all required packages and source utility files
source("project-setup.R")
```

<style>
/* Normalize all kableExtra HTML tables across the doc */
table.table {
  font-size: 0.875rem;              /* match Appendix 3 look */
}
table.table.table-sm > :not(caption) > * > * {
  padding: .3rem .5rem !important;  /* compact cell padding */
}
/* If any table misses the .table-sm class, still compact it */
table.table > :not(caption) > * > * {
  padding: .3rem .5rem;
}
</style>

## Table 0. Sample Sizes by Voter Group

```{r table_0_sample_sizes}
#| echo: false
#| warning: false
#| message: false

# Create a table showing sample sizes for each voter group
# Filter to voters only (those with party_switch_analysis defined)
voters_data <- data |> 
  filter(!is.na(party_switch_analysis))

# Party categories 
party_levels <- c("New Trump Voter", "Trump Voter", "New Harris Voter", "Biden/Harris Voter")

# Calculate unweighted and weighted counts for each group
sample_sizes <- map_dfr(party_levels, function(group) {
  group_data <- voters_data |> filter(party_switch_analysis == group)
  
  # Unweighted count
  unweighted_n <- nrow(group_data)
  
  # Weighted count
  weighted_n <- sum(group_data$WEIGHT_EN, na.rm = TRUE)
  
  tibble(
    `Voter Group` = group,
    `Unweighted N` = format(unweighted_n, big.mark = ","),
    `Weighted N` = format(round(weighted_n), big.mark = ",")
  )
})

# Add total row
total_unweighted <- nrow(voters_data)
total_weighted <- sum(voters_data$WEIGHT_EN, na.rm = TRUE)

sample_sizes <- bind_rows(
  sample_sizes,
  tibble(
    `Voter Group` = "<strong>Total Voters</strong>",
    `Unweighted N` = format(total_unweighted, big.mark = ","),
    `Weighted N` = format(round(total_weighted), big.mark = ",")
  )
)

# Add row for all respondents (including non-voters)
all_unweighted <- nrow(data)
all_weighted <- sum(data$WEIGHT_EN, na.rm = TRUE)

sample_sizes <- bind_rows(
  sample_sizes,
  tibble(
    `Voter Group` = "<strong>Total Sample (including non-voters)</strong>",
    `Unweighted N` = format(all_unweighted, big.mark = ","),
    `Weighted N` = format(round(all_weighted), big.mark = ",")
  )
)

# Display the table
sample_sizes |> 
  kable(escape = FALSE, format = "html", 
        caption = "Sample sizes for voter groups analyzed in Tables 1 and 2. All analyses are restricted to respondents who voted in the 2024 election.") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) |>
  row_spec(c(5, 6), bold = TRUE) |>
  footnote(general = "Voter groups are defined based on self-reported voting behavior in 2020 and 2024. 'New Trump Voter' = Did not vote Trump 2020, voted Trump 2024. 'Trump Voter' = Voted Trump in both elections. 'New Harris Voter' = Did not vote Biden 2020, voted Harris 2024. 'Biden/Harris Voter' = Voted Biden 2020 and Harris 2024.")
```

## Table 1. Vaccine-Related Questions

::: {.panel-tabset}
#### Full Table with SEs
```{r table_1_full}
#| echo: false
#| warning: false
#| message: false

# Define vaccine-related variables
vaccine_vars <- c(
  "JHU7_1",  # Health care
  "JHU7_2",  # Foreign policy
  "JHU7_3",  # Democracy
  "JHU7_4",  # Inflation
  "JHU7_5",  # Immigration
  "JHU7_6",  # Crime
  "JHU7_7",  # Jobs
  "JHU7_8",  # Abortion
  "JHU7_9",  # Vaccines
  "JHU7_10", # Poverty
  "JHU7_11", # Inequality
  "JHU7_12", # Education
  "JHU5A",   # Continue government support for vaccines
  "JHU6C"    # Removing school vaccination requirements
)

# Filter meta for this block
meta_vaccine <- meta |> filter(var %in% vaccine_vars)

# Party categories to loop across
party_levels <- c("New Trump Voter", "Trump Voter", "New Harris Voter", "Biden/Harris Voter")

# Build table
table_1 <- map_dfr(vaccine_vars, function(var) {
  # Prepare data for chi-square
  temp_data_all <- data |>
    filter(
      !is.na(get(var)),
      !get(var) %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
      !is.na(party_switch_analysis)
    ) |>
    mutate(.var = droplevels(factor(get(var))))
  
  temp_design_all <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = temp_data_all)
  
  # Special handling for headers
  if (var == "JHU7_1") {
    # Only add the election issues header for the first JHU7 question
    header_row <- tibble(
      Response = "<strong>Which issues, if any, mattered to you during the 2024 presidential election? Choose up to 3.</strong>",
      `All %` = "",
      `New Trump Voter %` = "",
      `Trump Voter %` = "",
      `New Harris Voter %` = "",
      `Biden/Harris Voter %` = ""
    )
  } else if (var == "JHU5A") {
    header_row <- tibble(
      Response = "<strong>Here is a list of specific policy goals. To what extent would you support or oppose them?</strong><br><em>Continue government support for safe and effective vaccines</em>",
      `All %` = "",
      `New Trump Voter %` = "",
      `Trump Voter %` = "",
      `New Harris Voter %` = "",
      `Biden/Harris Voter %` = ""
    )
  } else if (var == "JHU6C") {
    header_row <- tibble(
      Response = "<em>Removing school vaccination requirements for children</em>",
      `All %` = "",
      `New Trump Voter %` = "",
      `Trump Voter %` = "",
      `New Harris Voter %` = "",
      `Biden/Harris Voter %` = ""
    )
  } else {
    header_row <- NULL
  }
  
  # For JHU7 questions, we only want "Yes" responses
  if (str_starts(var, "JHU7_")) {
    temp_data <- data |> 
      filter(!is.na(get(var)), !is.na(party_switch_analysis)) |> 
      mutate(temp = ifelse(as.character(get(var)) == "Yes", 1, 0))
    
    temp_design <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = temp_data)
    
    # Calculate overall percentage
    overall_prop <- svymean(~temp, design = temp_design, na.rm = TRUE)
    overall_pct <- 100 * as.numeric(overall_prop)
    overall_se <- 100 * as.numeric(SE(overall_prop))
    
    # Calculate party-specific percentages
    prop_result <- svyby(
      ~temp,
      ~party_switch_analysis,
      design = temp_design,
      svymean,
      na.rm = TRUE,
      drop.empty.groups = FALSE
    )
    
    prop_df <- tibble(
      group = prop_result$party_switch_analysis,
      pct = 100 * as.numeric(prop_result$temp),
      se = 100 * as.numeric(SE(prop_result))
    ) |>
      right_join(tibble(group = party_levels), by = "group") |>
      mutate(
        pct = ifelse(is.na(pct), 0, pct),
        se = ifelse(is.na(se), 0, se),
        formatted = sprintf("%.1f (%.1f)", pct, se)
      )
    
    # Create response row with the correct topic
    topic <- meta_vaccine |> filter(var == !!var) |> pull(topic)
    response_row <- tibble(
      Response = ifelse(var == "JHU7_9", "<strong>Vaccines</strong>", topic),
      `All %` = sprintf("%.1f (%.1f)", overall_pct, overall_se),
      `New Trump Voter %` = prop_df$formatted[prop_df$group == "New Trump Voter"],
      `Trump Voter %` = prop_df$formatted[prop_df$group == "Trump Voter"],
      `New Harris Voter %` = prop_df$formatted[prop_df$group == "New Harris Voter"],
      `Biden/Harris Voter %` = prop_df$formatted[prop_df$group == "Biden/Harris Voter"]
    )
    
    if (!is.null(header_row)) {
      bind_rows(header_row, response_row)
    } else {
      response_row
    }
  } else {
    # Original handling for JHU5A and JHU6C
    responses <- levels(droplevels(factor(data[[var]])))
    responses <- responses[!responses %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")]
    
    category_rows <- map_dfr(responses, function(response) {
      temp_data <- data |> 
        filter(!is.na(get(var)), !is.na(party_switch_analysis)) |> 
        mutate(temp = ifelse(as.character(get(var)) == response, 1, 0))
      
      temp_design <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = temp_data)
      
      overall_prop <- svymean(~temp, design = temp_design, na.rm = TRUE)
      overall_pct <- 100 * as.numeric(overall_prop)
      overall_se <- 100 * as.numeric(SE(overall_prop))
      
      prop_result <- svyby(
        ~temp,
        ~party_switch_analysis,
        design = temp_design,
        svymean,
        na.rm = TRUE,
        drop.empty.groups = FALSE
      )
      
      prop_df <- tibble(
        group = prop_result$party_switch_analysis,
        pct = 100 * as.numeric(prop_result$temp),
        se = 100 * as.numeric(SE(prop_result))
      ) |>
        right_join(tibble(group = party_levels), by = "group") |>
        mutate(
          pct = ifelse(is.na(pct), 0, pct),
          se = ifelse(is.na(se), 0, se),
          formatted = sprintf("%.1f (%.1f)", pct, se)
        )
      
      tibble(
        Response = response,
        `All %` = sprintf("%.1f (%.1f)", overall_pct, overall_se),
        `New Trump Voter %` = prop_df$formatted[prop_df$group == "New Trump Voter"],
        `Trump Voter %` = prop_df$formatted[prop_df$group == "Trump Voter"],
        `New Harris Voter %` = prop_df$formatted[prop_df$group == "New Harris Voter"],
        `Biden/Harris Voter %` = prop_df$formatted[prop_df$group == "Biden/Harris Voter"]
      )
    })
    
    bind_rows(header_row, category_rows)
  }
})


table_1|> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  add_header_above(c(" " = 1, "All" = 1, "Weighted Estimates: % (SE)" = 4)) |>
  column_spec(1, width = "50%") |>
  column_spec(2:6, width = "10%") |>
  column_spec(2:6, extra_css = "white-space: nowrap; overflow: hidden;")
```

#### Without New Harris Voter
```{r table_2_no_new_harris}
#| echo: false
#| warning: false
#| message: false

table_1 |> 
  select(-`New Harris Voter %`) |>
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  add_header_above(c(" " = 1, "All" = 1, "Weighted Estimates: % (SE)" = 3)) |>
  column_spec(1, width = "50%") |>
  column_spec(2:5, width = "10%") |>
  column_spec(2:5, extra_css = "white-space: nowrap; overflow: hidden;")
```

#### Without Standard Errors
```{r table_1_no_se}
#| echo: false
#| warning: false
#| message: false

# Create a version without standard errors
table_1_no_se <- table_1 |>
  mutate(across(c(`All %`, `New Trump Voter %`, `Trump Voter %`, `New Harris Voter %`, `Biden/Harris Voter %`),
                ~str_replace(., "\\([0-9.]+\\).*$", "")))

table_1_no_se |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  add_header_above(c(" " = 1, "All" = 1, "Weighted Estimates: %" = 4)) |>
  column_spec(1, width = "50%") |>
  column_spec(2:6, width = "10%") |>
  column_spec(2:6, extra_css = "white-space: nowrap; overflow: hidden;")
```

#### Without SEs and New Harris
```{r table_1_no_se_no_new_harris}
#| echo: false
#| warning: false
#| message: false

# Create a version without standard errors and without New Harris Voter
table_1_no_se |> 
  select(-`New Harris Voter %`) |>
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  add_header_above(c(" " = 1, "All" = 1, "Weighted Estimates: %" = 3)) |>
  column_spec(1, width = "50%") |>
  column_spec(2:5, width = "10%") |>
  column_spec(2:5, extra_css = "white-space: nowrap; overflow: hidden;")
```
:::

## Table 2. Education vs. Vaccine Questions

```{r table_2_education_vaccine}
#| echo: false
#| warning: false
#| message: false

# Define vaccine-related variables
ed_vaccine_vars <- c(
  "JHU7_9",  # Vaccines as important election issue
  "JHU5A",   # Continue government support for vaccines
  "JHU6C"    # Removing school vaccination requirements
)

# Create survey design
svy_design <- svydesign(
  ids = ~1, 
  weights = ~WEIGHT_EN, 
  data = data,
  na.action = na.omit
)

# Function to create cross-tab for a single variable
create_ed_vaccine_crosstab <- function(var, question_text) {
  # Get all response categories for this variable
  responses <- levels(droplevels(factor(data[[var]])))
  responses <- responses[!responses %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")]
  
  # For JHU7_9, only show "Yes" responses and rename to "Vaccines"
  if (var == "JHU7_9") {
    responses <- responses[responses == "Yes"]
  }
  
  # Get education levels in original order
  ed_levels <- levels(droplevels(factor(data$education_cat)))
  
  # Create header row
  header_row <- tibble(
    Response = question_text
  )
  # Add empty columns for each education level
  for (ed in ed_levels) {
    header_row[[ed]] <- ""
  }
  
  # Create rows for each response category
  response_rows <- map_dfr(responses, function(response) {
    # Calculate percentages for each education level within this response
    ed_percents <- map_dfr(ed_levels, function(ed_level) {
      # Subset design for this education level
      ed_design <- subset(svy_design, education_cat == ed_level)
      
      # Calculate percentage for this response
      subset_design <- subset(ed_design, !is.na(get(var)) & get(var) == response)
      
      # Get weighted N for this response within this education level
      weighted_n <- sum(weights(subset_design))
      
      # Get total weighted N for this education level
      total_weighted_n <- sum(weights(ed_design))
      
      # Calculate percentage
      pct <- 100 * weighted_n / total_weighted_n
      
      # Calculate SE
      se <- tryCatch({
        ed_design$is_response <- as.numeric(ed_design$variables[[var]] == response)
        prop <- svymean(~is_response, design = ed_design, na.rm = TRUE)
        100 * as.numeric(SE(prop))
      }, error = function(e) {
        p <- weighted_n / total_weighted_n
        sqrt(p * (1 - p) / total_weighted_n) * 100
      })
      
      tibble(
        ed_level = ed_level,
        pct = pct,
        se = se
      )
    })
    
    # Create row with response and percentages
    # For JHU7_9, change "Yes" to "Vaccines"
    display_response <- ifelse(var == "JHU7_9" & response == "Yes", "Vaccines", response)
    row_data <- tibble(Response = display_response)
    for (ed in ed_levels) {
      row_data[[ed]] <- sprintf("%.1f (%.1f)", 
        ed_percents$pct[ed_percents$ed_level == ed],
        ed_percents$se[ed_percents$ed_level == ed])
    }
    
    row_data
  })
  
  bind_rows(header_row, response_rows)
}

# Create tables for each vaccine variable
table_2_0 <- create_ed_vaccine_crosstab(
  "JHU7_9",
  "<strong>Which issues, if any, mattered to you during the 2024 presidential election? Choose up to 3.</strong>"
)

table_2_1 <- create_ed_vaccine_crosstab(
  "JHU5A",
  "<strong>Continue government support for safe and effective vaccines</strong>"
)

table_2_2 <- create_ed_vaccine_crosstab(
  "JHU6C",
  "<strong>Removing school vaccination requirements for children</strong>"
)

# Combine tables
table_2_combined <- bind_rows(table_2_0, table_2_1, table_2_2)

# Display the table
table_2_combined |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(table_2_combined), width = paste0(70/(ncol(table_2_combined)-1), "%")) |>
  row_spec(which(str_detect(table_2_combined$Response, "<strong>")), bold = TRUE)
```


## Appendix Table 2. Demographics

::: {.panel-tabset}
#### Full Table with SEs
```{r demographics_table_full}
#| echo: false
#| warning: false
#| message: false

# Define variables of interest with proper names and documentation
demographic_vars <- c(
  "Age" = "age_cat",
  "Race/Ethnicity" = "race_eth_cat",
  "Gender" = "gender_cat",
  "Education" = "education_cat",
  "Income" = "income_cat",
  "Region" = "region_cat",
  "Party Identification" = "PartyID5"
)

# Create survey design
svy_design <- svydesign(
  ids = ~1, 
  weights = ~WEIGHT_EN, 
  data = data |> mutate(one = 1),
  na.action = na.omit
)

# Party categories to loop across
party_levels <- c("Trump Voter", "New Trump Voter", "Biden/Harris Voter", "New Harris Voter")

# Add total rows
total_rows <- tibble(
  Category = c("Total", "2020/2024 Voters"),
  `N` = c("", format(sum(!is.na(data$party_switch_analysis)), big.mark = ",")),
  `N (Wtd.)` = c("", format(round(sum(weights(subset(svy_design, !is.na(party_switch_analysis)))), 1), big.mark = ",")),
  `% (SE)` = c("", "100.0 (0.0)"),
  `New Trump Voter` = c("", ""),
  `Trump Voter` = c("", ""),
  `New Harris Voter` = c("", ""),
  `Biden/Harris Voter` = c("", "")
)

# Build the table
demographics_table <- map_dfr(names(demographic_vars), function(label) {
  var <- demographic_vars[[label]]
  
  # Get levels used in this variable
  groups <- levels(droplevels(factor(data[[var]])))
  
  # Filter out "Unknown" for Party Identification
  if (var == "PartyID5") {
    groups <- groups[groups != "Unknown"]
  }
  
  # Create dummy header row for the variable
  header_row <- tibble(
    Category = label,
    `N` = "",
    `N (Wtd.)` = "",
    `% (SE)` = "",
    `New Trump Voter` = "",
    `Trump Voter` = "",
    `New Harris Voter` = "",
    `Biden/Harris Voter` = ""
  )
  
  # Category-level rows
  category_rows <- map_dfr(groups, function(level_val) {
    # Calculate unweighted and weighted N
    unweighted_n <- sum(!is.na(data[[var]]) & data[[var]] == level_val & !is.na(data$party_switch_analysis))
    
    # Calculate column percentages for each vote status
    vote_status_percents <- map_dfr(party_levels, function(vote_status) {
      # Subset design for this vote status
      status_design <- subset(svy_design, party_switch_analysis == vote_status)
      
      # Calculate percentage of this demographic group within this vote status
      subset_design <- subset(status_design, !is.na(get(var)) & get(var) == level_val)
      
      # Get weighted N for this group within this vote status
      weighted_n <- sum(weights(subset_design))
      
      # Get total weighted N for this vote status
      total_weighted_n <- sum(weights(status_design))
      
      # Calculate percentage
      pct <- 100 * weighted_n / total_weighted_n
      
      # Calculate SE using survey package
      se <- tryCatch({
        # Create a binary indicator for this level
        status_design$is_level <- as.numeric(status_design$variables[[var]] == level_val)
        prop <- svymean(~is_level, design = status_design, na.rm = TRUE)
        100 * as.numeric(SE(prop))
      }, error = function(e) {
        # If error, calculate SE using the formula for a proportion
        p <- weighted_n / total_weighted_n
        sqrt(p * (1 - p) / total_weighted_n) * 100
      })
      
      tibble(
        vote_status = vote_status,
        pct = pct,
        se = se
      )
    })
    
    # Calculate overall percentage
    subset_design <- subset(svy_design, !is.na(get(var)) & get(var) == level_val)
    weighted_n <- sum(weights(subset_design))
    total_weighted_n <- sum(weights(svy_design))
    overall_pct <- 100 * weighted_n / total_weighted_n
    
    # Calculate overall SE
    overall_se <- tryCatch({
      svy_design$is_level <- as.numeric(svy_design$variables[[var]] == level_val)
      prop <- svymean(~is_level, design = svy_design, na.rm = TRUE)
      100 * as.numeric(SE(prop))
    }, error = function(e) {
      # If error, calculate SE using the formula for a proportion
      p <- weighted_n / total_weighted_n
      sqrt(p * (1 - p) / total_weighted_n) * 100
    })
    
    tibble(
      Category = as.character(level_val),
      `N` = format(unweighted_n, big.mark = ","),
      `N (Wtd.)` = format(round(weighted_n, 1), big.mark = ","),
      `% (SE)` = sprintf("%.1f (%.1f)", overall_pct, overall_se),
      `New Trump Voter` = sprintf("%.1f (%.1f)", 
        vote_status_percents$pct[vote_status_percents$vote_status == "New Trump Voter"],
        vote_status_percents$se[vote_status_percents$vote_status == "New Trump Voter"]),
      `Trump Voter` = sprintf("%.1f (%.1f)", 
        vote_status_percents$pct[vote_status_percents$vote_status == "Trump Voter"],
        vote_status_percents$se[vote_status_percents$vote_status == "Trump Voter"]),
      `New Harris Voter` = sprintf("%.1f (%.1f)", 
        vote_status_percents$pct[vote_status_percents$vote_status == "New Harris Voter"],
        vote_status_percents$se[vote_status_percents$vote_status == "New Harris Voter"]),
      `Biden/Harris Voter` = sprintf("%.1f (%.1f)", 
        vote_status_percents$pct[vote_status_percents$vote_status == "Biden/Harris Voter"],
        vote_status_percents$se[vote_status_percents$vote_status == "Biden/Harris Voter"])
    )
  })
  
  bind_rows(header_row, category_rows)
})

# Add total counts to the table
demographics_table <- bind_rows(
  total_rows,
  demographics_table
)

# Display the table with kable formatting
demographics_table |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  add_header_above(c(" " = 1, "All" = 3, "Weighted Estimates: % (SE)" = 4)) |>
  row_spec(which(demographics_table$Category %in% c(names(demographic_vars), "Total")), bold = TRUE)
```

#### Without New Harris Voter
```{r demographics_table_no_new_harris}
#| echo: false
#| warning: false
#| message: false

# Use the same demographics_table but remove the New Harris Voter column
demographics_table |> 
  select(-`New Harris Voter`) |>
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  add_header_above(c(" " = 1, "All" = 3, "Weighted Estimates: % (SE)" = 3)) |>
  row_spec(which(demographics_table$Category %in% c(names(demographic_vars), "Total")), bold = TRUE)
```

#### Without Standard Errors
```{r demographics_table_no_se}
#| echo: false
#| warning: false
#| message: false

# Create a version without standard errors
demographics_table_no_se <- demographics_table |>
  rename(
    `%` = `% (SE)`,
    `New Trump Voter %` = `New Trump Voter`,
    `Trump Voter %` = `Trump Voter`,
    `New Harris Voter %` = `New Harris Voter`,
    `Biden/Harris Voter %` = `Biden/Harris Voter`
  ) |>
  mutate(across(c(`%`, `New Trump Voter %`, `Trump Voter %`, `New Harris Voter %`, `Biden/Harris Voter %`),
                ~str_replace(., "\\([0-9.]+\\).*$", "")))

demographics_table_no_se |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  add_header_above(c(" " = 1, "All" = 3, "Weighted Estimates: %" = 4)) |>
  row_spec(which(demographics_table$Category %in% c(names(demographic_vars), "Total")), bold = TRUE)
```

#### Without SEs and New Harris
```{r demographics_table_no_se_no_new_harris}
#| echo: false
#| warning: false
#| message: false

# Create a version without standard errors and without New Harris Voter
demographics_table_no_se |> 
  select(-`New Harris Voter %`) |>
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) |>
  add_header_above(c(" " = 1, "All" = 3, "Weighted Estimates: %" = 3)) |>
  row_spec(which(demographics_table$Category %in% c(names(demographic_vars), "Total")), bold = TRUE)
```
:::

## Appendix 3. Demographic Cross-Tabulations

### Appendix 3A. Age Cross-Tabulations

```{r appendix_3a_age}
#| echo: false
#| warning: false
#| message: false

# Create generic cross-tabulation function for any demographic variable
create_demographic_vaccine_crosstab <- function(demo_var, demo_var_name) {
  # Define vaccine-related variables
  ed_vaccine_vars <- c(
    "JHU7_9",  # Vaccines as important election issue
    "JHU5A",   # Continue government support for vaccines
    "JHU6C"    # Removing school vaccination requirements
  )
  
  # Create survey design
  svy_design <- svydesign(
    ids = ~1, 
    weights = ~WEIGHT_EN, 
    data = data,
    na.action = na.omit
  )
  
  # Function to create cross-tab for a single variable
  create_single_crosstab <- function(var, question_text) {
    # Get all response categories for this variable
    responses <- levels(droplevels(factor(data[[var]])))
    responses <- responses[!responses %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")]
    
    # For JHU7_9, only show "Yes" responses and rename to "Vaccines"
    if (var == "JHU7_9") {
      responses <- responses[responses == "Yes"]
    }
    
    # Get demographic levels in original order
    demo_levels <- levels(droplevels(factor(data[[demo_var]])))
    
    # Create header row
    header_row <- tibble(
      Response = question_text
    )
    # Add empty columns for each demographic level
    for (demo in demo_levels) {
      header_row[[demo]] <- ""
    }
    
    # Create rows for each response category
    response_rows <- map_dfr(responses, function(response) {
      # Calculate percentages for each demographic level within this response
      demo_percents <- map_dfr(demo_levels, function(demo_level) {
        # Subset design for this demographic level
        demo_design <- subset(svy_design, get(demo_var) == demo_level)
        
        # Calculate percentage for this response
        subset_design <- subset(demo_design, !is.na(get(var)) & get(var) == response)
        
        # Get weighted N for this response within this demographic level
        weighted_n <- sum(weights(subset_design))
        
        # Get total weighted N for this demographic level
        total_weighted_n <- sum(weights(demo_design))
        
        # Calculate percentage
        pct <- 100 * weighted_n / total_weighted_n
        
        # Calculate SE
        se <- tryCatch({
          demo_design$is_response <- as.numeric(demo_design$variables[[var]] == response)
          prop <- svymean(~is_response, design = demo_design, na.rm = TRUE)
          100 * as.numeric(SE(prop))
        }, error = function(e) {
          p <- weighted_n / total_weighted_n
          sqrt(p * (1 - p) / total_weighted_n) * 100
        })
        
        tibble(
          demo_level = demo_level,
          pct = pct,
          se = se
        )
      })
      
      # Create row with response and percentages
      # For JHU7_9, change "Yes" to "Vaccines"
      display_response <- ifelse(var == "JHU7_9" & response == "Yes", "Vaccines", response)
      row_data <- tibble(Response = display_response)
      for (demo in demo_levels) {
        row_data[[demo]] <- sprintf("%.1f (%.1f)", 
          demo_percents$pct[demo_percents$demo_level == demo],
          demo_percents$se[demo_percents$demo_level == demo])
      }
      
      row_data
    })
    
    bind_rows(header_row, response_rows)
  }
  
  # Create tables for each vaccine variable
  table_1 <- create_single_crosstab(
    "JHU7_9",
    "<strong>Which issues, if any, mattered to you during the 2024 presidential election? Choose up to 3.</strong>"
  )
  
  table_2 <- create_single_crosstab(
    "JHU5A",
    "<strong>Continue government support for safe and effective vaccines</strong>"
  )
  
  table_3 <- create_single_crosstab(
    "JHU6C",
    "<strong>Removing school vaccination requirements for children</strong>"
  )
  
  # Combine tables
  combined_table <- bind_rows(table_1, table_2, table_3)
  
  return(combined_table)
}

# Create Age cross-tabulation table
appendix_3a <- create_demographic_vaccine_crosstab("age_cat", "Age")

# Display the table
appendix_3a |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(appendix_3a), width = paste0(70/(ncol(appendix_3a)-1), "%")) |>
  row_spec(which(str_detect(appendix_3a$Response, "<strong>")), bold = TRUE)
```

### Appendix 3B. Gender Cross-Tabulations

```{r appendix_3b_gender}
#| echo: false
#| warning: false
#| message: false

# Create Gender cross-tabulation table
appendix_3b <- create_demographic_vaccine_crosstab("gender_cat", "Gender")

# Display the table
appendix_3b |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(appendix_3b), width = paste0(70/(ncol(appendix_3b)-1), "%")) |>
  row_spec(which(str_detect(appendix_3b$Response, "<strong>")), bold = TRUE)
```

### Appendix 3C. Income Cross-Tabulations

```{r appendix_3c_income}
#| echo: false
#| warning: false
#| message: false

# Create Income cross-tabulation table
appendix_3c <- create_demographic_vaccine_crosstab("income_cat", "Income")

# Display the table
appendix_3c |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(appendix_3c), width = paste0(70/(ncol(appendix_3c)-1), "%")) |>
  row_spec(which(str_detect(appendix_3c$Response, "<strong>")), bold = TRUE)
```

### Appendix 3D. Race/Ethnicity Cross-Tabulations

```{r appendix_3d_race}
#| echo: false
#| warning: false
#| message: false

# Create Race/Ethnicity cross-tabulation table
appendix_3d <- create_demographic_vaccine_crosstab("race_eth_cat", "Race/Ethnicity")

# Display the table
appendix_3d |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(appendix_3d), width = paste0(70/(ncol(appendix_3d)-1), "%")) |>
  row_spec(which(str_detect(appendix_3d$Response, "<strong>")), bold = TRUE)
```

### Appendix 3E. Education Cross-Tabulations

```{r appendix_3e_education}
#| echo: false
#| warning: false
#| message: false

# Create Education cross-tabulation table
appendix_3e <- create_demographic_vaccine_crosstab("education_cat", "Education")

# Display the table
appendix_3e |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(appendix_3e), width = paste0(70/(ncol(appendix_3e)-1), "%")) |>
  row_spec(which(str_detect(appendix_3e$Response, "<strong>")), bold = TRUE)
```

### Appendix 3F. Education (Collapsed Categories) Cross-Tabulations

```{r appendix_3f_education_collapsed}
#| echo: false
#| warning: false
#| message: false

# Create function for collapsed education categories
create_collapsed_education_crosstab <- function() {
  # First create the collapsed education variable
  data_collapsed <- data |>
    mutate(
      education_collapsed = case_when(
        education_cat %in% c("Less than high school", "High school graduate or equivalent") ~ "HS or Less",
        education_cat == "Some college/associates degree" ~ "Some college/associates",
        education_cat %in% c("Bachelor's degree", "Postgraduate study/professional degree") ~ "Bachelor's or Higher",
        TRUE ~ NA_character_
      )
    )
  
  results_list <- list()
  
  # Add header for election issues
  header_election <- tibble(
    Response = "<strong>Which issues, if any, mattered to you during the 2024 presidential election? Choose up to 3.</strong>",
    `HS or Less` = "",
    `Some college/associates` = "",
    `Bachelor's or Higher` = ""
  )
  results_list[["header_election"]] <- header_election
  
  # Process JHU7_9 - Vaccines as election issue
  data_jhu7_9 <- data_collapsed |>
    filter(
      !is.na(JHU7_9),
      !JHU7_9 %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
      !is.na(education_collapsed)
    ) |>
    mutate(is_yes = as.numeric(JHU7_9 == "Yes"))
  
  svy_jhu7_9 <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = data_jhu7_9)
  props_jhu7_9 <- svyby(~is_yes, ~education_collapsed, svy_jhu7_9, svymean, na.rm = TRUE)
  
  jhu7_9_row <- tibble(
    Response = "Vaccines",
    `HS or Less` = sprintf("%.1f (%.1f)", 
                          props_jhu7_9$is_yes[props_jhu7_9$education_collapsed == "HS or Less"] * 100,
                          SE(props_jhu7_9)[props_jhu7_9$education_collapsed == "HS or Less"] * 100),
    `Some college/associates` = sprintf("%.1f (%.1f)", 
                                       props_jhu7_9$is_yes[props_jhu7_9$education_collapsed == "Some college/associates"] * 100,
                                       SE(props_jhu7_9)[props_jhu7_9$education_collapsed == "Some college/associates"] * 100),
    `Bachelor's or Higher` = sprintf("%.1f (%.1f)", 
                                    props_jhu7_9$is_yes[props_jhu7_9$education_collapsed == "Bachelor's or Higher"] * 100,
                                    SE(props_jhu7_9)[props_jhu7_9$education_collapsed == "Bachelor's or Higher"] * 100)
  )
  results_list[["jhu7_9"]] <- jhu7_9_row
  
  # Add header for JHU5A
  header_jhu5a <- tibble(
    Response = "<strong>Continue government support for safe and effective vaccines</strong>",
    `HS or Less` = "",
    `Some college/associates` = "",
    `Bachelor's or Higher` = ""
  )
  results_list[["header_jhu5a"]] <- header_jhu5a
  
  # Process JHU5A responses
  data_jhu5a <- data_collapsed |>
    filter(
      !is.na(JHU5A),
      !JHU5A %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
      !is.na(education_collapsed)
    )
  
  svy_jhu5a <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = data_jhu5a)
  
  # Calculate proportions for each response
  for (response in c("Strongly support", "Support", "Neither support nor oppose", 
                     "Oppose", "Strongly oppose")) {
    data_jhu5a_resp <- data_jhu5a |>
      mutate(is_response = as.numeric(JHU5A == response))
    
    svy_resp <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = data_jhu5a_resp)
    props_resp <- svyby(~is_response, ~education_collapsed, svy_resp, svymean, na.rm = TRUE)
    
    response_row <- tibble(
      Response = response,
      `HS or Less` = sprintf("%.1f (%.1f)", 
                            props_resp$is_response[props_resp$education_collapsed == "HS or Less"] * 100,
                            SE(props_resp)[props_resp$education_collapsed == "HS or Less"] * 100),
      `Some college/associates` = sprintf("%.1f (%.1f)", 
                                         props_resp$is_response[props_resp$education_collapsed == "Some college/associates"] * 100,
                                         SE(props_resp)[props_resp$education_collapsed == "Some college/associates"] * 100),
      `Bachelor's or Higher` = sprintf("%.1f (%.1f)", 
                                      props_resp$is_response[props_resp$education_collapsed == "Bachelor's or Higher"] * 100,
                                      SE(props_resp)[props_resp$education_collapsed == "Bachelor's or Higher"] * 100)
    )
    results_list[[paste0("jhu5a_", response)]] <- response_row
  }
  
  # Add header for JHU6C
  header_jhu6c <- tibble(
    Response = "<strong>Removing school vaccination requirements for children</strong>",
    `HS or Less` = "",
    `Some college/associates` = "",
    `Bachelor's or Higher` = ""
  )
  results_list[["header_jhu6c"]] <- header_jhu6c
  
  # Process JHU6C responses
  data_jhu6c <- data_collapsed |>
    filter(
      !is.na(JHU6C),
      !JHU6C %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
      !is.na(education_collapsed)
    )
  
  svy_jhu6c <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = data_jhu6c)
  
  # Calculate proportions for each response
  for (response in c("Strongly support", "Support", "Neither support nor oppose", 
                     "Oppose", "Strongly oppose")) {
    data_jhu6c_resp <- data_jhu6c |>
      mutate(is_response = as.numeric(JHU6C == response))
    
    svy_resp <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = data_jhu6c_resp)
    props_resp <- svyby(~is_response, ~education_collapsed, svy_resp, svymean, na.rm = TRUE)
    
    response_row <- tibble(
      Response = response,
      `HS or Less` = sprintf("%.1f (%.1f)", 
                            props_resp$is_response[props_resp$education_collapsed == "HS or Less"] * 100,
                            SE(props_resp)[props_resp$education_collapsed == "HS or Less"] * 100),
      `Some college/associates` = sprintf("%.1f (%.1f)", 
                                         props_resp$is_response[props_resp$education_collapsed == "Some college/associates"] * 100,
                                         SE(props_resp)[props_resp$education_collapsed == "Some college/associates"] * 100),
      `Bachelor's or Higher` = sprintf("%.1f (%.1f)", 
                                      props_resp$is_response[props_resp$education_collapsed == "Bachelor's or Higher"] * 100,
                                      SE(props_resp)[props_resp$education_collapsed == "Bachelor's or Higher"] * 100)
    )
    results_list[[paste0("jhu6c_", response)]] <- response_row
  }
  
  # Combine all results
  bind_rows(results_list)
}

# Create the collapsed education table
appendix_3f <- create_collapsed_education_crosstab()

# Display the table
appendix_3f |> 
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "40%") |>
  column_spec(2:ncol(appendix_3f), width = paste0(60/(ncol(appendix_3f)-1), "%")) |>
  row_spec(which(str_detect(appendix_3f$Response, "<strong>")), bold = TRUE)
```

## Appendix 4. Education Differences Analysis

```{r education_differences_function}
#| echo: false
#| warning: false
#| message: false

# Function to analyze education differences for vaccine questions
analyze_education_differences <- function(var, question_text) {
  
  # Create survey design
  svy_design <- svydesign(
    ids = ~1, 
    weights = ~WEIGHT_EN, 
    data = data,
    na.action = na.omit
  )
  
  # Filter out non-responses
  svy_filtered <- subset(svy_design, 
    !get(var) %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED") &
    !is.na(education_cat))
  
  # Get response levels
  responses <- levels(droplevels(factor(svy_filtered$variables[[var]])))
  
  # For JHU7_9, only analyze "Yes" responses
  if (var == "JHU7_9") {
    responses <- responses[responses == "Yes"]
  }
  
  # Calculate percentages by education level for each response
  results_list <- list()
  
  for (response in responses) {
    # Create indicators for this response
    svy_filtered$variables$is_response <- as.numeric(svy_filtered$variables[[var]] == response)
    
    # Calculate weighted percentages by education
    edu_props <- svyby(~is_response, ~education_cat, svy_filtered, svymean, na.rm = TRUE)
    
    # Extract percentages for all 5 education levels
    less_than_hs <- edu_props$is_response[edu_props$education_cat == "Less than high school"] * 100
    high_school <- edu_props$is_response[edu_props$education_cat == "High school graduate or equivalent"] * 100
    some_college <- edu_props$is_response[edu_props$education_cat == "Some college/associates degree"] * 100
    bachelors <- edu_props$is_response[edu_props$education_cat == "Bachelor's degree"] * 100
    postgrad <- edu_props$is_response[edu_props$education_cat == "Postgraduate study/professional degree"] * 100
    
    # Calculate differences
    postgrad_less_hs_diff <- postgrad - less_than_hs
    bachelors_hs_diff <- bachelors - high_school
    
    # Store results - focusing on differences
    results_list[[response]] <- tibble(
      Response = response,
      `Less than HS %` = sprintf("%.1f", less_than_hs),
      `High School %` = sprintf("%.1f", high_school),
      `Some College %` = sprintf("%.1f", some_college),
      `Bachelor's %` = sprintf("%.1f", bachelors),
      `Postgraduate %` = sprintf("%.1f", postgrad),
      `Postgrad - Less HS Diff` = sprintf("%+.1f", postgrad_less_hs_diff),
      `Bachelor's - HS Diff` = sprintf("%+.1f", bachelors_hs_diff)
    )
  }
  
  # Perform Rao-Scott chi-square test - fixing the formula
  chi_sq_result <- tryCatch({
    # Create formula for association test
    formula_str <- as.formula(paste0("~", var, " + education_cat"))
    test <- svychisq(formula_str, 
                      design = svy_filtered, 
                      statistic = "Chisq")
    list(
      statistic = as.numeric(test$statistic),
      p_value = as.numeric(test$p.value),
      df = as.numeric(test$parameter)
    )
  }, error = function(e) {
    # Try alternative approach if first fails
    tryCatch({
      # Ensure variables are factors
      svy_filtered$variables[[var]] <- factor(svy_filtered$variables[[var]])
      svy_filtered$variables$education_cat <- factor(svy_filtered$variables$education_cat)
      
      test <- svychisq(as.formula(paste0("~", var, " + education_cat")), 
                        design = svy_filtered, 
                        statistic = "Chisq")
      list(
        statistic = as.numeric(test$statistic),
        p_value = as.numeric(test$p.value),
        df = as.numeric(test$parameter)
      )
    }, error = function(e2) {
      list(statistic = NA, p_value = NA, df = NA)
    })
  })
  
  # Combine results
  results_df <- bind_rows(results_list)
  
  # Add chi-square test results as a row
  chi_sq_row <- tibble(
    Response = "Rao-Scott χ² Test",
    `Less than HS %` = "",
    `High School %` = "",
    `Some College %` = "",
    `Bachelor's %` = "",
    `Postgraduate %` = "",
    `Postgrad - Less HS Diff` = ifelse(is.na(chi_sq_result$statistic), 
                                        "χ² = NA", 
                                        sprintf("χ² = %.2f (df=%d)", chi_sq_result$statistic, chi_sq_result$df)),
    `Bachelor's - HS Diff` = ifelse(is.na(chi_sq_result$p_value), 
                                    "p = NA", 
                                    sprintf("p = %.4f", chi_sq_result$p_value))
  )
  
  # Add question header
  header_row <- tibble(
    Response = paste0("<strong>", question_text, "</strong>"),
    `Less than HS %` = "",
    `High School %` = "",
    `Some College %` = "",
    `Bachelor's %` = "",
    `Postgraduate %` = "",
    `Postgrad - Less HS Diff` = "",
    `Bachelor's - HS Diff` = ""
  )
  
  bind_rows(header_row, results_df, chi_sq_row)
}
```

### Table 4A. Comprehensive Demographic Differences Analysis

```{r table_4e_demographic_differences}
#| echo: false
#| warning: false
#| message: false

# Calculate all demographic differences
calculate_demographic_differences <- function() {
  
  # Define all variables to analyze
  election_vars <- c(
    "JHU7_1" = "Health care",
    "JHU7_2" = "Foreign policy", 
    "JHU7_3" = "Democracy",
    "JHU7_4" = "Inflation",
    "JHU7_5" = "Immigration",
    "JHU7_6" = "Crime",
    "JHU7_7" = "Jobs",
    "JHU7_8" = "Abortion",
    "JHU7_9" = "Vaccines",
    "JHU7_10" = "Poverty",
    "JHU7_11" = "Inequality",
    "JHU7_12" = "Education"
  )
  
  results_list <- list()
  
  # Add header row for election issues
  results_list[["header_election"]] <- tibble(
    Question = "<strong>Which issues, if any, mattered to you during the 2024 presidential election? Choose up to 3.</strong>",
    `Age: 60+ vs 18-29` = "",
    `Gender: Male vs Female` = "",
    `Income: $100K+ vs <$30K` = "",
    `Race: White vs Black` = "",
    `Educ 1: Postgrad vs <HS` = "",
    `Educ 2: Bachelor+ vs HS-` = ""
  )
  
  # Process election issue variables
  for (var in names(election_vars)) {
    tryCatch({
      # Prepare data
      temp_data <- data |>
        filter(
          !is.na(.data[[var]]),
          !.data[[var]] %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")
        ) |>
        mutate(
          is_yes = as.numeric(.data[[var]] == "Yes"),
          # Create binary education variable for second comparison
          education_binary = case_when(
            education_cat %in% c("Less than high school", "High school graduate or equivalent") ~ "HS or Less",
            education_cat %in% c("Bachelor's degree", "Postgraduate study/professional degree") ~ "Bachelor's or More",
            TRUE ~ NA_character_
          )
        )
      
      # Age: 60+ vs 18-29
      age_diff <- tryCatch({
        age_data <- temp_data |> filter(!is.na(age_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = age_data)
        props <- svyby(~is_yes, ~age_cat, svy, svymean, na.rm = TRUE)
        age_60plus <- props$is_yes[props$age_cat == "60+"] * 100
        age_18_29 <- props$is_yes[props$age_cat == "18-29"] * 100
        sprintf("%+.1f", age_60plus - age_18_29)
      }, error = function(e) "—")
      
      # Gender: Male vs Female
      gender_diff <- tryCatch({
        gender_data <- temp_data |> filter(!is.na(gender_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = gender_data)
        props <- svyby(~is_yes, ~gender_cat, svy, svymean, na.rm = TRUE)
        male <- props$is_yes[props$gender_cat == "Male"] * 100
        female <- props$is_yes[props$gender_cat == "Female"] * 100
        sprintf("%+.1f", male - female)
      }, error = function(e) "—")
      
      # Income: $100K+ vs <$30K
      income_diff <- tryCatch({
        income_data <- temp_data |> filter(!is.na(income_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = income_data)
        props <- svyby(~is_yes, ~income_cat, svy, svymean, na.rm = TRUE)
        high_income <- props$is_yes[props$income_cat == "$100,000 or more"] * 100
        low_income <- props$is_yes[props$income_cat == "Less than $30,000"] * 100
        sprintf("%+.1f", high_income - low_income)
      }, error = function(e) "—")
      
      # Race: White vs Black
      race_diff <- tryCatch({
        race_data <- temp_data |> filter(!is.na(race_eth_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = race_data)
        props <- svyby(~is_yes, ~race_eth_cat, svy, svymean, na.rm = TRUE)
        white <- props$is_yes[grepl("White", props$race_eth_cat)] * 100
        black <- props$is_yes[grepl("Black", props$race_eth_cat)] * 100
        sprintf("%+.1f", white[1] - black[1])
      }, error = function(e) "—")
      
      # Education 1: Postgrad vs Less than HS
      edu1_diff <- tryCatch({
        edu_data <- temp_data |> filter(education_cat %in% c("Less than high school", "Postgraduate study/professional degree"))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_data)
        props <- svyby(~is_yes, ~education_cat, svy, svymean, na.rm = TRUE)
        postgrad <- props$is_yes[props$education_cat == "Postgraduate study/professional degree"] * 100
        less_hs <- props$is_yes[props$education_cat == "Less than high school"] * 100
        sprintf("%+.1f", postgrad - less_hs)
      }, error = function(e) "—")
      
      # Education 2: Bachelor+ vs HS or Less
      edu2_diff <- tryCatch({
        edu_binary_data <- temp_data |> filter(!is.na(education_binary))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_binary_data)
        props <- svyby(~is_yes, ~education_binary, svy, svymean, na.rm = TRUE)
        bachelor_plus <- props$is_yes[props$education_binary == "Bachelor's or More"] * 100
        hs_or_less <- props$is_yes[props$education_binary == "HS or Less"] * 100
        sprintf("%+.1f", bachelor_plus - hs_or_less)
      }, error = function(e) "—")
      
      results_list[[var]] <- tibble(
        Question = election_vars[var],
        `Age: 60+ vs 18-29` = age_diff,
        `Gender: Male vs Female` = gender_diff,
        `Income: $100K+ vs <$30K` = income_diff,
        `Race: White vs Black` = race_diff,
        `Educ 1: Postgrad vs <HS` = edu1_diff,
        `Educ 2: Bachelor+ vs HS-` = edu2_diff
      )
    }, error = function(e) NULL)
  }
  
  # Add empty row
  results_list[["empty1"]] <- tibble(
    Question = "",
    `Age: 60+ vs 18-29` = "",
    `Gender: Male vs Female` = "",
    `Income: $100K+ vs <$30K` = "",
    `Race: White vs Black` = "",
    `Educ 1: Postgrad vs <HS` = "",
    `Educ 2: Bachelor+ vs HS-` = ""
  )
  
  # Process JHU5A - Continue government support
  results_list[["header_jhu5a"]] <- tibble(
    Question = "<strong>Continue government support for safe and effective vaccines</strong>",
    `Age: 60+ vs 18-29` = "",
    `Gender: Male vs Female` = "",
    `Income: $100K+ vs <$30K` = "",
    `Race: White vs Black` = "",
    `Educ 1: Postgrad vs <HS` = "",
    `Educ 2: Bachelor+ vs HS-` = ""
  )
  
  # Process JHU5A responses
  for (response in c("Strongly support", "Support", "Neither support nor oppose", "Oppose", "Strongly oppose")) {
    tryCatch({
      temp_data <- data |>
        filter(
          !is.na(JHU5A),
          !JHU5A %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")
        ) |>
        mutate(
          is_response = as.numeric(JHU5A == response),
          education_binary = case_when(
            education_cat %in% c("Less than high school", "High school graduate or equivalent") ~ "HS or Less",
            education_cat %in% c("Bachelor's degree", "Postgraduate study/professional degree") ~ "Bachelor's or More",
            TRUE ~ NA_character_
          )
        )
      
      # Calculate differences for each demographic
      age_diff <- tryCatch({
        age_data <- temp_data |> filter(!is.na(age_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = age_data)
        props <- svyby(~is_response, ~age_cat, svy, svymean, na.rm = TRUE)
        age_60plus <- props$is_response[props$age_cat == "60+"] * 100
        age_18_29 <- props$is_response[props$age_cat == "18-29"] * 100
        sprintf("%+.1f", age_60plus - age_18_29)
      }, error = function(e) "—")
      
      gender_diff <- tryCatch({
        gender_data <- temp_data |> filter(!is.na(gender_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = gender_data)
        props <- svyby(~is_response, ~gender_cat, svy, svymean, na.rm = TRUE)
        male <- props$is_response[props$gender_cat == "Male"] * 100
        female <- props$is_response[props$gender_cat == "Female"] * 100
        sprintf("%+.1f", male - female)
      }, error = function(e) "—")
      
      income_diff <- tryCatch({
        income_data <- temp_data |> filter(!is.na(income_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = income_data)
        props <- svyby(~is_response, ~income_cat, svy, svymean, na.rm = TRUE)
        high_income <- props$is_response[props$income_cat == "$100,000 or more"] * 100
        low_income <- props$is_response[props$income_cat == "Less than $30,000"] * 100
        sprintf("%+.1f", high_income - low_income)
      }, error = function(e) "—")
      
      race_diff <- tryCatch({
        race_data <- temp_data |> filter(!is.na(race_eth_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = race_data)
        props <- svyby(~is_response, ~race_eth_cat, svy, svymean, na.rm = TRUE)
        white <- props$is_response[grepl("White", props$race_eth_cat)] * 100
        black <- props$is_response[grepl("Black", props$race_eth_cat)] * 100
        sprintf("%+.1f", white[1] - black[1])
      }, error = function(e) "—")
      
      edu1_diff <- tryCatch({
        edu_data <- temp_data |> filter(education_cat %in% c("Less than high school", "Postgraduate study/professional degree"))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_data)
        props <- svyby(~is_response, ~education_cat, svy, svymean, na.rm = TRUE)
        postgrad <- props$is_response[props$education_cat == "Postgraduate study/professional degree"] * 100
        less_hs <- props$is_response[props$education_cat == "Less than high school"] * 100
        sprintf("%+.1f", postgrad - less_hs)
      }, error = function(e) "—")
      
      edu2_diff <- tryCatch({
        edu_binary_data <- temp_data |> filter(!is.na(education_binary))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_binary_data)
        props <- svyby(~is_response, ~education_binary, svy, svymean, na.rm = TRUE)
        bachelor_plus <- props$is_response[props$education_binary == "Bachelor's or More"] * 100
        hs_or_less <- props$is_response[props$education_binary == "HS or Less"] * 100
        sprintf("%+.1f", bachelor_plus - hs_or_less)
      }, error = function(e) "—")
      
      results_list[[paste0("jhu5a_", response)]] <- tibble(
        Question = response,
        `Age: 60+ vs 18-29` = age_diff,
        `Gender: Male vs Female` = gender_diff,
        `Income: $100K+ vs <$30K` = income_diff,
        `Race: White vs Black` = race_diff,
        `Educ 1: Postgrad vs <HS` = edu1_diff,
        `Educ 2: Bachelor+ vs HS-` = edu2_diff
      )
    }, error = function(e) NULL)
  }
  
  # Add empty row
  results_list[["empty2"]] <- tibble(
    Question = "",
    `Age: 60+ vs 18-29` = "",
    `Gender: Male vs Female` = "",
    `Income: $100K+ vs <$30K` = "",
    `Race: White vs Black` = "",
    `Educ 1: Postgrad vs <HS` = "",
    `Educ 2: Bachelor+ vs HS-` = ""
  )
  
  # Process JHU6C - Remove school vaccination requirements
  results_list[["header_jhu6c"]] <- tibble(
    Question = "<strong>Removing school vaccination requirements for children</strong>",
    `Age: 60+ vs 18-29` = "",
    `Gender: Male vs Female` = "",
    `Income: $100K+ vs <$30K` = "",
    `Race: White vs Black` = "",
    `Educ 1: Postgrad vs <HS` = "",
    `Educ 2: Bachelor+ vs HS-` = ""
  )
  
  # Process JHU6C responses
  for (response in c("Strongly support", "Support", "Neither support nor oppose", "Oppose", "Strongly oppose")) {
    tryCatch({
      temp_data <- data |>
        filter(
          !is.na(JHU6C),
          !JHU6C %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED")
        ) |>
        mutate(
          is_response = as.numeric(JHU6C == response),
          education_binary = case_when(
            education_cat %in% c("Less than high school", "High school graduate or equivalent") ~ "HS or Less",
            education_cat %in% c("Bachelor's degree", "Postgraduate study/professional degree") ~ "Bachelor's or More",
            TRUE ~ NA_character_
          )
        )
      
      # Calculate differences (same pattern as above)
      age_diff <- tryCatch({
        age_data <- temp_data |> filter(!is.na(age_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = age_data)
        props <- svyby(~is_response, ~age_cat, svy, svymean, na.rm = TRUE)
        age_60plus <- props$is_response[props$age_cat == "60+"] * 100
        age_18_29 <- props$is_response[props$age_cat == "18-29"] * 100
        sprintf("%+.1f", age_60plus - age_18_29)
      }, error = function(e) "—")
      
      gender_diff <- tryCatch({
        gender_data <- temp_data |> filter(!is.na(gender_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = gender_data)
        props <- svyby(~is_response, ~gender_cat, svy, svymean, na.rm = TRUE)
        male <- props$is_response[props$gender_cat == "Male"] * 100
        female <- props$is_response[props$gender_cat == "Female"] * 100
        sprintf("%+.1f", male - female)
      }, error = function(e) "—")
      
      income_diff <- tryCatch({
        income_data <- temp_data |> filter(!is.na(income_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = income_data)
        props <- svyby(~is_response, ~income_cat, svy, svymean, na.rm = TRUE)
        high_income <- props$is_response[props$income_cat == "$100,000 or more"] * 100
        low_income <- props$is_response[props$income_cat == "Less than $30,000"] * 100
        sprintf("%+.1f", high_income - low_income)
      }, error = function(e) "—")
      
      race_diff <- tryCatch({
        race_data <- temp_data |> filter(!is.na(race_eth_cat))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = race_data)
        props <- svyby(~is_response, ~race_eth_cat, svy, svymean, na.rm = TRUE)
        white <- props$is_response[grepl("White", props$race_eth_cat)] * 100
        black <- props$is_response[grepl("Black", props$race_eth_cat)] * 100
        sprintf("%+.1f", white[1] - black[1])
      }, error = function(e) "—")
      
      edu1_diff <- tryCatch({
        edu_data <- temp_data |> filter(education_cat %in% c("Less than high school", "Postgraduate study/professional degree"))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_data)
        props <- svyby(~is_response, ~education_cat, svy, svymean, na.rm = TRUE)
        postgrad <- props$is_response[props$education_cat == "Postgraduate study/professional degree"] * 100
        less_hs <- props$is_response[props$education_cat == "Less than high school"] * 100
        sprintf("%+.1f", postgrad - less_hs)
      }, error = function(e) "—")
      
      edu2_diff <- tryCatch({
        edu_binary_data <- temp_data |> filter(!is.na(education_binary))
        svy <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = edu_binary_data)
        props <- svyby(~is_response, ~education_binary, svy, svymean, na.rm = TRUE)
        bachelor_plus <- props$is_response[props$education_binary == "Bachelor's or More"] * 100
        hs_or_less <- props$is_response[props$education_binary == "HS or Less"] * 100
        sprintf("%+.1f", bachelor_plus - hs_or_less)
      }, error = function(e) "—")
      
      results_list[[paste0("jhu6c_", response)]] <- tibble(
        Question = response,
        `Age: 60+ vs 18-29` = age_diff,
        `Gender: Male vs Female` = gender_diff,
        `Income: $100K+ vs <$30K` = income_diff,
        `Race: White vs Black` = race_diff,
        `Educ 1: Postgrad vs <HS` = edu1_diff,
        `Educ 2: Bachelor+ vs HS-` = edu2_diff
      )
    }, error = function(e) NULL)
  }
  
  bind_rows(results_list)
}

# Generate the comprehensive table
table_4a <- calculate_demographic_differences()

# Display the table
table_4a |>
  kable(escape = FALSE, format = "html") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = TRUE) |>
  column_spec(1, width = "30%") |>
  column_spec(2:ncol(table_4a), width = paste0(70/(ncol(table_4a)-1), "%")) |>
  row_spec(which(str_detect(table_4a$Question, "<strong>")), bold = TRUE)
```

### Table 4B. Education Data Exploration

#### JHU7_9 (Vaccines as Election Issue)

```{r jhu7_9_data_exploration}
#| echo: false
#| warning: false
#| message: false

# 1. JHU7_9 - Vaccines as election issue
jhu7_9_data <- data |>
  filter(
    !is.na(JHU7_9),
    !JHU7_9 %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
    !is.na(education_cat),
    !is.na(WEIGHT_EN)
  )

# Response categories - drop unused factor levels
jhu7_9_data$JHU7_9 <- droplevels(jhu7_9_data$JHU7_9)
response_table_7_9 <- as.data.frame(table(jhu7_9_data$JHU7_9))
names(response_table_7_9) <- c("Response", "Count")

cat("Total N:", nrow(jhu7_9_data), "\n")

kable(response_table_7_9, caption = "JHU7_9 Response Categories") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Crosstab
crosstab_7_9 <- table(jhu7_9_data$JHU7_9, jhu7_9_data$education_cat)
kable(crosstab_7_9, caption = "JHU7_9 x Education (Unweighted)") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Unweighted Chi-square test
chi_test_7_9 <- chisq.test(crosstab_7_9)
cat("Unweighted Chi-square: χ² =", round(chi_test_7_9$statistic, 3), 
    ", df =", chi_test_7_9$parameter, 
    ", p-value =", format(chi_test_7_9$p.value, digits = 4), "\n")

# Weighted Rao-Scott Chi-square test
svy_7_9 <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = jhu7_9_data)
rao_scott_7_9 <- svychisq(~JHU7_9 + education_cat, design = svy_7_9, statistic = "Chisq")
cat("Rao-Scott Chi-square: χ² =", round(as.numeric(rao_scott_7_9$statistic), 3), 
    ", df =", as.numeric(rao_scott_7_9$parameter), 
    ", p-value =", format(as.numeric(rao_scott_7_9$p.value), digits = 4), "\n")
```

#### JHU5A (Continue Government Support for Vaccines)

```{r jhu5a_data_exploration}
#| echo: false
#| warning: false
#| message: false

# 2. JHU5A - Continue government support
jhu5a_data <- data |>
  filter(
    !is.na(JHU5A),
    !JHU5A %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
    !is.na(education_cat),
    !is.na(WEIGHT_EN)
  )

# Response categories - drop unused factor levels
jhu5a_data$JHU5A <- droplevels(jhu5a_data$JHU5A)
response_table_5a <- as.data.frame(table(jhu5a_data$JHU5A))
names(response_table_5a) <- c("Response", "Count")

cat("Total N:", nrow(jhu5a_data), "\n")

kable(response_table_5a, caption = "JHU5A Response Categories") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Crosstab
crosstab_5a <- table(jhu5a_data$JHU5A, jhu5a_data$education_cat)
kable(crosstab_5a, caption = "JHU5A x Education (Unweighted)") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Unweighted Chi-square test
chi_test_5a <- chisq.test(crosstab_5a)
cat("Unweighted Chi-square: χ² =", round(chi_test_5a$statistic, 3), 
    ", df =", chi_test_5a$parameter, 
    ", p-value =", format(chi_test_5a$p.value, digits = 4), "\n")

# Weighted Rao-Scott Chi-square test
svy_5a <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = jhu5a_data)
rao_scott_5a <- svychisq(~JHU5A + education_cat, design = svy_5a, statistic = "Chisq")
cat("Rao-Scott Chi-square: χ² =", round(as.numeric(rao_scott_5a$statistic), 3), 
    ", df =", as.numeric(rao_scott_5a$parameter), 
    ", p-value =", format(as.numeric(rao_scott_5a$p.value), digits = 4), "\n")
```

#### JHU6C (Removing School Vaccination Requirements)

```{r jhu6c_data_exploration}
#| echo: false
#| warning: false
#| message: false

# 3. JHU6C - Remove school vaccination requirements
jhu6c_data <- data |>
  filter(
    !is.na(JHU6C),
    !JHU6C %in% c("DON'T KNOW", "SKIPPED ON WEB", "REFUSED"),
    !is.na(education_cat),
    !is.na(WEIGHT_EN)
  )

# Response categories - drop unused factor levels
jhu6c_data$JHU6C <- droplevels(jhu6c_data$JHU6C)
response_table_6c <- as.data.frame(table(jhu6c_data$JHU6C))
names(response_table_6c) <- c("Response", "Count")

cat("Total N:", nrow(jhu6c_data), "\n")

kable(response_table_6c, caption = "JHU6C Response Categories") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Crosstab
crosstab_6c <- table(jhu6c_data$JHU6C, jhu6c_data$education_cat)
kable(crosstab_6c, caption = "JHU6C x Education (Unweighted)") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Unweighted Chi-square test
chi_test_6c <- chisq.test(crosstab_6c)
cat("Unweighted Chi-square: χ² =", round(chi_test_6c$statistic, 3), 
    ", df =", chi_test_6c$parameter, 
    ", p-value =", format(chi_test_6c$p.value, digits = 4), "\n")

# Weighted Rao-Scott Chi-square test
svy_6c <- svydesign(ids = ~1, weights = ~WEIGHT_EN, data = jhu6c_data)
rao_scott_6c <- svychisq(~JHU6C + education_cat, design = svy_6c, statistic = "Chisq")
cat("Rao-Scott Chi-square: χ² =", round(as.numeric(rao_scott_6c$statistic), 3), 
    ", df =", as.numeric(rao_scott_6c$parameter), 
    ", p-value =", format(as.numeric(rao_scott_6c$p.value), digits = 4), "\n")
```


## Save Tables for Word Document

RDS files are saved in the `output` directory.

```{r save_tables}
#| echo: false
#| warning: false
#| message: false

# Create data directory if it doesn't exist
dir.create("data", showWarnings = FALSE)

# Save Table 1 (without New Harris Voter, with SEs)
table_1_no_harris <- table_1 |> 
  select(-`New Harris Voter %`)

# Save Appendix Table 2 (without New Harris Voter)
appendix_demographics_table_no_harris <- demographics_table |> 
  select(-`New Harris Voter`)

if(!dir.exists("output")) {
  dir.create("output")
}

# Save to RDS files
saveRDS(table_1_no_harris, "output/table_1.rds")
saveRDS(table_2_combined, "output/table_2.rds")
saveRDS(appendix_demographics_table_no_harris, "output/appendix_demographics_table.rds")
saveRDS(appendix_3a, "output/appendix_3a_age.rds")
saveRDS(appendix_3b, "output/appendix_3b_gender.rds")
saveRDS(appendix_3c, "output/appendix_3c_income.rds")
saveRDS(appendix_3d, "output/appendix_3d_race.rds")
saveRDS(appendix_3e, "output/appendix_3e_education.rds")
saveRDS(appendix_3f, "output/appendix_3f_education_collapsed.rds")

# Save Table 4A comprehensive demographic differences
saveRDS(table_4a, "output/table_4a_demographic_differences.rds")
```
